#include "posit16_math.h"

posit16_t rlibm_sqrt(posit16_t x) {
    if (x.v >= 0x8000) {
        x.v = 0x8000;
        return x;
    } else if (x.v == 0x0) {
        return x;
    }
    
    // Extract exponent and mantissa
    int m;
    float fx = frexpf(convertP16ToDouble(x), &m);
    
    if ((m & 0x1) == 0) {
        fx *= 4.0;
        m -= 2;
    } else {
        fx *= 2.0;
        m--;
    }
    
    // Instead of [0.5, 2) make it [1/8, 0.5)
    m >>= 1;
    
    double y = 0;
    
    if (fx <= 2.14599609375) {
        y = -2.3530402643644897538177662710268123191781342029571533203125e-03;
        y *= fx;
        y += 2.62819293630375920567399106175798806361854076385498046875e-02;
        y *= fx;
        y += -1.27171841275129426929169085269677452743053436279296875e-01;
        y *= fx;
        y += 3.530868073027828568655195340397767722606658935546875e-01;
        y *= fx;
        y += -6.4843843364755160418866353211342357099056243896484375e-01;
        y *= fx;
        y += 1.129000996028148851024752730154432356357574462890625;
        y *= fx;
        y += 2.69593592709484630720595532693550921976566314697265625e-01;
    } else {
        y = -2.1374405303079146056961790112183052769978530704975128173828125e-05;
        y *= fx;
        y += 5.74776888286255573622118841825567869818769395351409912109375e-04;
        y *= fx;
        y += -6.6014424010839810319506426594671211205422878265380859375e-03;
        y *= fx;
        y += 4.305139568476913647376846938641392625868320465087890625e-02;
        y *= fx;
        y += -1.842527001546831189049413524116971530020236968994140625e-01;
        y *= fx;
        y += 7.4313621747255442784307888359762728214263916015625e-01;
        y *= fx;
        y += 4.09156298855834987815427439272752963006496429443359375e-01;
    }
    
    y = ldexp(y, m);
    return convertDoubleToP16(y);
}
